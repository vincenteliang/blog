<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node | Akara的博客</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="Fooly Cooly">
    <link rel="preload" href="/blog/assets/css/0.styles.90c0c9ab.css" as="style"><link rel="preload" href="/blog/assets/js/app.92e3121e.js" as="script"><link rel="preload" href="/blog/assets/js/2.53a0586d.js" as="script"><link rel="preload" href="/blog/assets/js/26.00670705.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a9b70b88.js"><link rel="prefetch" href="/blog/assets/js/11.5a6bd33f.js"><link rel="prefetch" href="/blog/assets/js/12.93d84bce.js"><link rel="prefetch" href="/blog/assets/js/13.8db1ed10.js"><link rel="prefetch" href="/blog/assets/js/14.d54f8742.js"><link rel="prefetch" href="/blog/assets/js/15.7ee9103a.js"><link rel="prefetch" href="/blog/assets/js/16.768fba66.js"><link rel="prefetch" href="/blog/assets/js/17.825a2628.js"><link rel="prefetch" href="/blog/assets/js/18.60b9ae26.js"><link rel="prefetch" href="/blog/assets/js/19.cf34c2ab.js"><link rel="prefetch" href="/blog/assets/js/20.fd8109e6.js"><link rel="prefetch" href="/blog/assets/js/21.8063b184.js"><link rel="prefetch" href="/blog/assets/js/22.34d6263d.js"><link rel="prefetch" href="/blog/assets/js/23.46355e20.js"><link rel="prefetch" href="/blog/assets/js/24.a0f0269a.js"><link rel="prefetch" href="/blog/assets/js/25.821ae1ce.js"><link rel="prefetch" href="/blog/assets/js/27.fee56496.js"><link rel="prefetch" href="/blog/assets/js/28.01e3d01e.js"><link rel="prefetch" href="/blog/assets/js/29.34ab3b19.js"><link rel="prefetch" href="/blog/assets/js/3.bfd5cd10.js"><link rel="prefetch" href="/blog/assets/js/30.b8fe1ec0.js"><link rel="prefetch" href="/blog/assets/js/31.410a6c6d.js"><link rel="prefetch" href="/blog/assets/js/32.74b2855d.js"><link rel="prefetch" href="/blog/assets/js/33.38c768ad.js"><link rel="prefetch" href="/blog/assets/js/34.6cedaec3.js"><link rel="prefetch" href="/blog/assets/js/35.7e74e587.js"><link rel="prefetch" href="/blog/assets/js/36.00e6b684.js"><link rel="prefetch" href="/blog/assets/js/37.7fcb8395.js"><link rel="prefetch" href="/blog/assets/js/38.52acfd9f.js"><link rel="prefetch" href="/blog/assets/js/39.4dc4c88c.js"><link rel="prefetch" href="/blog/assets/js/4.bd080ec4.js"><link rel="prefetch" href="/blog/assets/js/40.ce088750.js"><link rel="prefetch" href="/blog/assets/js/41.83844528.js"><link rel="prefetch" href="/blog/assets/js/42.a8801109.js"><link rel="prefetch" href="/blog/assets/js/43.7dc7b009.js"><link rel="prefetch" href="/blog/assets/js/44.509dd717.js"><link rel="prefetch" href="/blog/assets/js/45.038d96bf.js"><link rel="prefetch" href="/blog/assets/js/46.239b76a4.js"><link rel="prefetch" href="/blog/assets/js/47.dc2a1282.js"><link rel="prefetch" href="/blog/assets/js/48.3008e98f.js"><link rel="prefetch" href="/blog/assets/js/49.c92ec341.js"><link rel="prefetch" href="/blog/assets/js/5.2f69950d.js"><link rel="prefetch" href="/blog/assets/js/6.53f0df2c.js"><link rel="prefetch" href="/blog/assets/js/7.d498b94a.js"><link rel="prefetch" href="/blog/assets/js/8.262808e3.js"><link rel="prefetch" href="/blog/assets/js/9.52ba186d.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.90c0c9ab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Akara的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/frontend/" class="nav-link router-link-active">
  前端博客
</a></div><div class="nav-item"><a href="/blog/mianshi/" class="nav-link">
  面经
</a></div><div class="nav-item"><a href="/blog/gossip/" class="nav-link">
  杂记
</a></div><div class="nav-item"><a href="https://messiahhh.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  随笔
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://messiahhh.github.io/resume/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简历
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/messiahhh/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/frontend/" class="nav-link router-link-active">
  前端博客
</a></div><div class="nav-item"><a href="/blog/mianshi/" class="nav-link">
  面经
</a></div><div class="nav-item"><a href="/blog/gossip/" class="nav-link">
  杂记
</a></div><div class="nav-item"><a href="https://messiahhh.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  随笔
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://messiahhh.github.io/resume/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简历
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/messiahhh/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/frontend/" aria-current="page" class="sidebar-link">HTML</a></li><li><a href="/blog/frontend/css.html" class="sidebar-link">CSS</a></li><li><a href="/blog/frontend/javascript.html" class="sidebar-link">JavaScript</a></li><li><a href="/blog/frontend/node.html" aria-current="page" class="active sidebar-link">Node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#node" class="sidebar-link">Node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#npm" class="sidebar-link">NPM</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#事件循环" class="sidebar-link">事件循环</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#宏-微任务-队列" class="sidebar-link" style="padding-left:4rem;">宏/微任务，队列</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#浏览器事件循环" class="sidebar-link" style="padding-left:4rem;">浏览器事件循环</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#node中的事件循环" class="sidebar-link" style="padding-left:4rem;">Node中的事件循环</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#高低版本node的差异" class="sidebar-link" style="padding-left:4rem;">高低版本Node的差异</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#http模块" class="sidebar-link">http模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#静态目录" class="sidebar-link" style="padding-left:4rem;">静态目录</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#处理post请求-文件上传" class="sidebar-link" style="padding-left:4rem;">处理Post请求（文件上传）</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#fs模块" class="sidebar-link">fs模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#readfile" class="sidebar-link" style="padding-left:4rem;">readFile</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#writefile" class="sidebar-link" style="padding-left:4rem;">writeFile</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#createreadstream" class="sidebar-link" style="padding-left:4rem;">createReadStream</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#createwritestream" class="sidebar-link" style="padding-left:4rem;">createWriteStream</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#path模块" class="sidebar-link">path模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#dirname" class="sidebar-link" style="padding-left:4rem;">__dirname</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#path-resolve" class="sidebar-link" style="padding-left:4rem;">path.resolve</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#path-join" class="sidebar-link" style="padding-left:4rem;">path.join</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#os模块" class="sidebar-link">os模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process模块" class="sidebar-link">process模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-cwd" class="sidebar-link" style="padding-left:4rem;">process.cwd()</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-argv" class="sidebar-link" style="padding-left:4rem;">process.argv</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-stdout" class="sidebar-link" style="padding-left:4rem;">process.stdout</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-stdin" class="sidebar-link" style="padding-left:4rem;">process.stdin</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#child-process模块" class="sidebar-link">child_process模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#fork-exec-execfile-spawn" class="sidebar-link" style="padding-left:4rem;">fork/exec/execFile/spawn</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#cluster模块" class="sidebar-link">cluster模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#url模块" class="sidebar-link">url模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#querystring模块" class="sidebar-link">querystring模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#event模块" class="sidebar-link">event模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#bluebird库" class="sidebar-link">bluebird库</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#bluebird-fs" class="sidebar-link" style="padding-left:4rem;">bluebird + fs</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#bluebird-mysql" class="sidebar-link" style="padding-left:4rem;">bluebird + mysql</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#pm2库" class="sidebar-link">PM2库</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#常用命令" class="sidebar-link" style="padding-left:4rem;">常用命令</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#命令行工具" class="sidebar-link">命令行工具</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#commander" class="sidebar-link" style="padding-left:4rem;">commander</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#readline" class="sidebar-link" style="padding-left:4rem;">readline</a></li></ul></li></ul></li><li><a href="/blog/frontend/koa.html" class="sidebar-link">Koa</a></li><li><a href="/blog/frontend/react.html" class="sidebar-link">React</a></li><li><a href="/blog/frontend/vue.html" class="sidebar-link">Vue</a></li><li><a href="/blog/frontend/react-vs-vue.html" class="sidebar-link">React和Vue的对比</a></li><li><a href="/blog/frontend/typescript.html" class="sidebar-link">TypeScript</a></li><li><a href="/blog/frontend/browser.html" class="sidebar-link">浏览器相关</a></li><li><a href="/blog/frontend/前端工程化.html" class="sidebar-link">前端工程化</a></li><li><a href="/blog/frontend/计算机网络.html" class="sidebar-link">计算机网络相关</a></li><li><a href="/blog/frontend/前端安全.html" class="sidebar-link">前端安全</a></li><li><a href="/blog/frontend/网站优化.html" class="sidebar-link">性能优化</a></li><li><a href="/blog/frontend/错误监控.html" class="sidebar-link">错误监控</a></li><li><a href="/blog/frontend/设计模式.html" class="sidebar-link">设计模式</a></li><li><a href="/blog/frontend/数据结构.html" class="sidebar-link">数据结构</a></li><li><a href="/blog/frontend/排序.html" class="sidebar-link">排序算法</a></li><li><a href="/blog/frontend/编程题.html" class="sidebar-link">编程题</a></li><li><a href="/blog/frontend/面试题.html" class="sidebar-link">面试题</a></li><li><a href="/blog/frontend/git.html" class="sidebar-link">Git</a></li><li><a href="/blog/frontend/mysql.html" class="sidebar-link">Mysql</a></li><li><a href="/blog/frontend/mongodb.html" class="sidebar-link">Mongodb</a></li><li><a href="/blog/frontend/linux.html" class="sidebar-link">Linux相关</a></li><li><a href="/blog/frontend/websocket.html" class="sidebar-link">WebSocket</a></li><li><a href="/blog/frontend/php.html" class="sidebar-link">PHP</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="node"><a href="#node" class="header-anchor">#</a> Node</h2> <h3 id="npm"><a href="#npm" class="header-anchor">#</a> NPM</h3> <p>安装的npm包放在<code>node_modules</code>目录下，可以这样使用：</p> <ol><li><div class="language-shell extra-class"><pre class="language-shell"><code>./node_modules/.bin/pm2 list
</code></pre></div></li> <li><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// npm run start</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pm2 list&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><div class="language-shell extra-class"><pre class="language-shell"><code>npx pm2 list
</code></pre></div></li></ol> <p>通过npm发布包很简单，其实就两步</p> <ol><li><code>npm login</code></li> <li><code>npm publish</code></li></ol> <p>此时npm的镜像需要是官方镜像<code>npm config set registry https://registry.npmjs.org</code></p> <p>另外我们可以创建类似<code>@akara/package</code>这样的库，这是属于用户作用域的包，默认是私有的。而我们不能直接发布私有包，因此我们需要使用以下代码来发布</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> publish --access public
</code></pre></div><p>当我们发布一个npm库时，通常目的是发布构建后的文件，所以我们需要控制哪些文件可以被发布，哪些文件不会被发布。</p> <ol><li><code>.gitignore</code>中的文件不会被发布</li> <li><code>.npmignore</code>中的文件不会被发布</li> <li><code>package.json</code>中的<code>files</code>字段指定哪些文件会被发布</li></ol> <h3 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h3> <h5 id="宏-微任务-队列"><a href="#宏-微任务-队列" class="header-anchor">#</a> 宏/微任务，队列</h5> <p>宏任务<code>macroTask</code>， 包括:  <code>setTimeout/setInterval</code>，<code>setImmediate</code>(Node专有)， I/O操作（包括读写文件/发送请求等）。宏任务放在宏队列中。</p> <p>微任务<code>microTask</code>， 包括:  <code>promise.then</code>等。微任务放在微队列中。</p> <p>除此之外，<code>process.nextTick</code>的回调函数是放进<code>nextTick</code>队列的。该队列类似微队列，但其执行总在微队列之前。</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'promise'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// nextTick</span>
<span class="token comment">// promise</span>
</code></pre></div><p>浏览器通过主线程和工作线程实现事件循环。</p> <p>Node通过libuv来实现事件循环。</p> <h5 id="浏览器事件循环"><a href="#浏览器事件循环" class="header-anchor">#</a> 浏览器事件循环</h5> <p>浏览器内维持着<strong>一个宏任务队列，一个微任务队列</strong>。</p> <p>执行宏队列中的第一个宏任务 =&gt; 执行微队列中的所有微任务 =&gt; 执行宏队列中的下一个宏任务 =&gt; 执行微队列中的所有微任务...如此往复。我们最初的同步脚本可以看作最初的宏任务。</p> <h5 id="node中的事件循环"><a href="#node中的事件循环" class="header-anchor">#</a> Node中的事件循环</h5> <p>Node事件循环一共有<strong>六个阶段</strong>，<strong>每个阶段中都有一个宏队列</strong>，<strong>总共只有一个微队列</strong></p> <p>在高版本Node（v11以后），Node的行为与浏览器表现一致，即执行完一个宏任务就执行所有的微任务。</p> <p>在旧版本Node（v11以前）：必须执行完一个阶段中宏队列内的全部宏任务，才回去执行所有微任务。</p> <p>Node事件循环的六个阶段：</p> <ol><li>Timer: <code>SetTimeout</code>和<code>SetInterval</code>的回调放进该阶段的队列。</li> <li>pending callback: 执行一些系统操作的回调，例如TCP的错误。</li> <li>idle, prepare: 处理一些内部调用。</li> <li>poll: <strong>大部分回调在这里调用。</strong></li> <li>check: <code>SetImmediate</code>的任务放进这个阶段的宏队列执行。</li> <li>close callback: 一些结束时的回调，例如<code>Socket.on(&quot;close&quot;)</code></li></ol> <h5 id="高低版本node的差异"><a href="#高低版本node的差异" class="header-anchor">#</a> 高低版本Node的差异</h5> <p>高低版本的Node有着显著的差异，如以下代码，在高低版本的Node下的结果就会不同。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol><li>当我们遇到<code>setImmediate</code>后，将其回调函数放进<code>check</code>阶段的宏队列中。</li> <li>当我们遇到<code>process.nextTick</code>后，将其回调函数放进<code>nextTick</code>队列中。因为此时同步代码（或者说最初的宏任务）执行完毕，那么执行<code>nextTick</code>队列中的任务。</li> <li><strong>输出2</strong>， 遇到<code>setImmediate</code>后，将其回调函数放进<code>check</code>阶段的宏队列中。</li> <li>开始执行<code>check</code>队列中的宏任务。</li> <li>执行<code>check</code>第一个宏任务，<strong>输出1</strong>，将<code>nextTick</code>的回调放进队列里。</li></ol> <p>以上五步，无论版本如何都是一致的，接下来就是高低版本Node的不同。</p> <p><strong>低版本Node</strong></p> <p>因为低版本Node是执<strong>行完一个阶段中的全部宏任务后，再执行微队列的全部任务</strong>。所以<strong>先输出3，再输出4。</strong></p> <p><strong>高版本Node</strong></p> <p>因为高版本Node是<strong>执行完一个宏任务，就执行微队列的全部任务</strong>。所以<strong>先输出4，再输出3。</strong></p> <h3 id="http模块"><a href="#http模块" class="header-anchor">#</a> http模块</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token comment">// 请求url</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token comment">// 请求方法</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token comment">// 请求头部</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置响应的状态码和头部</span>
        res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 单独设置状态码</span>
        res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span>
        <span class="token comment">// 单独设置响应头部</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
        <span class="token comment">// Set-Cookie</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token string">'name=akara; secure'</span><span class="token punctuation">)</span>
		
        <span class="token comment">// 设置响应实体</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;!!!&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">// 发送响应报文</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务器跑在3000端口&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="静态目录"><a href="#静态目录" class="header-anchor">#</a> 静态目录</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'static'</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFileAsync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
            res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;404 Not Found&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 或者</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> fileName <span class="token operator">=</span> url<span class="token punctuation">.</span>pathname
        <span class="token keyword">let</span> type
        <span class="token keyword">switch</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'css'</span><span class="token operator">:</span>
                type <span class="token operator">=</span> <span class="token string">'text/css; charset=utf-8'</span>
                <span class="token keyword">break</span>
            <span class="token keyword">case</span> <span class="token string">'js'</span><span class="token operator">:</span>
                type <span class="token operator">=</span> <span class="token string">'applaction/javascript; charset=utf-8'</span>
                <span class="token keyword">break</span>
            <span class="token comment">// other situations </span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                type <span class="token operator">=</span> <span class="token string">'application/octet-stream'</span>
                <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./static</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> type<span class="token punctuation">}</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;404错误啦！&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>


</code></pre></div><h5 id="处理post请求-文件上传"><a href="#处理post请求-文件上传" class="header-anchor">#</a> 处理Post请求（文件上传）</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 前端 (省略部分代码)</span>
<span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> data
<span class="token keyword">let</span> header
<span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    header <span class="token operator">=</span> <span class="token string">'application/x-www-form-urlencoded'</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">File</span> <span class="token operator">||</span> data <span class="token keyword">instanceof</span> <span class="token class-name">FormData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    header <span class="token operator">=</span> <span class="token string">'multipart/form-data; boundary=---xxxxxxxxxxxx'</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    header <span class="token operator">=</span> <span class="token string">'application/json'</span>
    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token comment">// 后端</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/upload'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">let</span> segment <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// chunk为Buffer对象</span>
            <span class="token comment">// 字符串aaa=bbb对应的Buffer对象如下</span>
            <span class="token comment">// &lt;Buffer 61 61 61 3d 62 62 62&gt;</span>
            segment<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 文件上传代码</span>
            segment <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span>
            <span class="token comment">// 下方代码获取buffer转成的字符串</span>
            <span class="token comment">// segment = Buffer.concat(segment).toString()</span>
            fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'fileName'</span><span class="token punctuation">,</span> segment<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;文件上传成功！&quot;</span><span class="token punctuation">)</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务器跑在3000端口&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="fs模块"><a href="#fs模块" class="header-anchor">#</a> fs模块</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="readfile"><a href="#readfile" class="header-anchor">#</a> readFile</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./image.png'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="writefile"><a href="#writefile" class="header-anchor">#</a> writeFile</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 写入文本</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'index.txt'</span><span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
<span class="token comment">// 写入buffer</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'image.png'</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>
</code></pre></div><h5 id="createreadstream"><a href="#createreadstream" class="header-anchor">#</a> createReadStream</h5> <h5 id="createwritestream"><a href="#createwritestream" class="header-anchor">#</a> createWriteStream</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> reader <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
<span class="token keyword">const</span> stream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./image/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.jpg</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
reader<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
</code></pre></div><h3 id="path模块"><a href="#path模块" class="header-anchor">#</a> path模块</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="dirname"><a href="#dirname" class="header-anchor">#</a> __dirname</h5> <p>返回当前文件所在的绝对路径</p> <h5 id="path-resolve"><a href="#path-resolve" class="header-anchor">#</a> path.resolve</h5> <p>将一个路径解析成绝对路径</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path1 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'static'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path1<span class="token punctuation">)</span>
<span class="token comment">// 输出</span>
<span class="token constant">C</span><span class="token operator">:</span>\Users\Messiah\test\<span class="token keyword">static</span>
</code></pre></div><h5 id="path-join"><a href="#path-join" class="header-anchor">#</a> path.join</h5> <p>用平台特定的分割符号(Linux为<code>/</code>， Window为<code>\</code>)对路径进行拼接</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path1 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path2 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'a/b'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path3 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c/d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path2<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path3<span class="token punctuation">)</span>
<span class="token comment">// 输出</span>
<span class="token constant">C</span><span class="token operator">:</span>\Users\Messiah\test\a
<span class="token constant">C</span><span class="token operator">:</span>\Users\Messiah\test\a\b
\a\b\c\d

<span class="token keyword">const</span> path4 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/static'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path5 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'/static'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="os模块"><a href="#os模块" class="header-anchor">#</a> os模块</h3> <p>获取操作系统相关信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> homedir <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">homedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 获取用户目录</span>
</code></pre></div><h3 id="process模块"><a href="#process模块" class="header-anchor">#</a> process模块</h3> <h5 id="process-cwd"><a href="#process-cwd" class="header-anchor">#</a> process.cwd()</h5> <p>获取执行脚本时所在的目录</p> <h5 id="process-argv"><a href="#process-argv" class="header-anchor">#</a> process.argv</h5> <p>获取执行脚本时命令行输入的参数</p> <div class="language-js extra-class"><pre class="language-js"><code>$node index<span class="token punctuation">.</span>js abc
<span class="token punctuation">[</span>
    <span class="token string">'node'</span><span class="token punctuation">,</span>
    <span class="token string">'index.js'</span><span class="token punctuation">,</span>
    <span class="token string">'abc'</span>
<span class="token punctuation">]</span>
</code></pre></div><h5 id="process-stdout"><a href="#process-stdout" class="header-anchor">#</a> process.stdout</h5> <p>标准输出流</p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Hello world'</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="process-stdin"><a href="#process-stdin" class="header-anchor">#</a> process.stdin</h5> <p>标准输入流</p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Hello'</span> <span class="token operator">+</span> chunk<span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="child-process模块"><a href="#child-process模块" class="header-anchor">#</a> child_process模块</h3> <h5 id="fork-exec-execfile-spawn"><a href="#fork-exec-execfile-spawn" class="header-anchor">#</a> fork/exec/execFile/spawn</h5> <p>node的child_process提供了创建子进程的方式。一共有四种，分别是spawn，execFile，exec，fork。</p> <p>其中，只有fork是用来创建node程序的子进程，而前三个用来创建shell程序的子进程。</p> <p>至于spawn，execFile和exec的区别。</p> <p>首先，spawn是基于流的形式，而后两者是基于回调的形式。</p> <p>而spawn和execFile的调用方式相同，与exec的调用方式不同。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'a.txt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">execFile</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'a.txt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'cat a.txt'</span><span class="token punctuation">)</span>
</code></pre></div><p>另外，使用exec执行一些危险的脚本（如rm -rf）是会直接执行的；而execFile碰到一些危险的操作会爆出异常。因此execFile的安全性更高。</p> <p>使用方式如下（用到了util.promisify，从而使用async/await形式的exec）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
<span class="token comment">// text.txt 有四行</span>
<span class="token comment">// a</span>
<span class="token comment">// c</span>
<span class="token comment">// b</span>
<span class="token comment">// a</span>
<span class="token keyword">const</span> file <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'text.txt'</span><span class="token punctuation">)</span>


<span class="token comment">// exec</span>
<span class="token keyword">const</span> exec <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>exec<span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>cat $<span class="token punctuation">{</span>file<span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// execFile</span>
<span class="token keyword">const</span> exec <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>execFile<span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// spawn</span>
<span class="token keyword">const</span> cat <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sort <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'sort'</span><span class="token punctuation">)</span>

cat<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span>
sort<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>

<span class="token comment">// fork</span>

<span class="token comment">// parent.js</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'./child.js'</span><span class="token punctuation">)</span>

<span class="token comment">// IPC</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  child<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>

<span class="token comment">// child.js</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'akara'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="cluster模块"><a href="#cluster模块" class="header-anchor">#</a> cluster模块</h3> <p>使用cluster来搭建集群node应用</p> <p>怎么讲呢，直接看网上的代码吧。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 获取CPU的个数</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">worker<span class="token punctuation">,</span> code<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'worker '</span> <span class="token operator">+</span> worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid <span class="token operator">+</span> <span class="token string">' died'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;hello world\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>以上代码，父进程根据CPU的数量创建子进程。只看代码的话，容易理解成每一个进程都创建了一个server来监听8000端口，但这是不切实际的。其实cluster做了很多事情，在实际的情况下，父进程会创建server监听端口，收到的请求会分发给不同的进程去处理。</p> <p>cluster让我们不用亲自去管理进程通信的事情（process.on('message')），而且也自带负载均衡的策略。</p> <p>默认情况，除了windows系统下，使用cluster时的负载均衡策略为round-robin。比如刚才的服务器，收到了8个请求，第一个请求交给第一个子进程处理，第二个请求交给第二个子进程...</p> <p>在windows系统下，通过以下代码来设置负载均衡策略为round-robin</p> <p>cluster.schedulingPolicy = cluster.SCHED_RR;</p> <p>另外，pm2也自带cluster，比如可以靠以下代码创建8个子进程。</p> <p>pm2 start app.js -i 8</p> <h3 id="url模块"><a href="#url模块" class="header-anchor">#</a> url模块</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 当请求url为 http://localhost:3000/index.html?name=akara#aa</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>
    search<span class="token punctuation">,</span> <span class="token comment">// '?name=akara'</span>
    query<span class="token punctuation">,</span> <span class="token comment">// 'name=akara'</span>
    pathname<span class="token punctuation">,</span> <span class="token comment">// '/index.html'</span>
    path<span class="token punctuation">,</span> <span class="token comment">// '/index.html?name=akara'</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
</code></pre></div><h3 id="querystring模块"><a href="#querystring模块" class="header-anchor">#</a> querystring模块</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'foo=bar&amp;abc=xyz&amp;abc=123'</span><span class="token punctuation">;</span>

querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token comment">// { foo: 'bar', abc: [ 'xyz', '123' ] }</span>
</code></pre></div><h3 id="event模块"><a href="#event模块" class="header-anchor">#</a> event模块</h3> <blockquote><p>实现原理见本文的设计模式-发布订阅章节</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>EventEmitter
<span class="token keyword">var</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ev'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'ev'</span><span class="token punctuation">)</span>
</code></pre></div><hr> <p>以上是Node自带的核心库，下面介绍一些常用的第三方库。</p> <h3 id="bluebird库"><a href="#bluebird库" class="header-anchor">#</a> bluebird库</h3> <p>可以将回调函数实现的异步改写成Promise的方式来写的第三方库。</p> <h5 id="bluebird-fs"><a href="#bluebird-fs" class="header-anchor">#</a> bluebird + fs</h5> <p>回调</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Promise</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> bluebird <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bluebird'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> bluebird<span class="token punctuation">.</span><span class="token function">promisifyAll</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

fs<span class="token punctuation">.</span><span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="bluebird-mysql"><a href="#bluebird-mysql" class="header-anchor">#</a> bluebird + mysql</h5> <p>回调</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>
<span class="token comment">// mysql配置文件</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 使用</span>
conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sql code here...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Promise</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> bluebird <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bluebird'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>
<span class="token comment">// mysql配置文件</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> conn <span class="token operator">=</span> bluebird<span class="token punctuation">.</span><span class="token function">promisifyAll</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 使用</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span><span class="token function">queryAsync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sql code here...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><h3 id="pm2库"><a href="#pm2库" class="header-anchor">#</a> PM2库</h3> <p>除了常见的<code>pm2 start index.js</code>，我们也可以使用配置文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 比如取名为 ecosystem.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  apps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    script<span class="token operator">:</span> <span class="token string">'./server/app.js'</span><span class="token punctuation">,</span>
    watch<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
    env_development<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;REACT_APP_NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;development&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    env_production<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;REACT_APP_NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之后通过以下命令来启动服务</p> <div class="language-shell extra-class"><pre class="language-shell"><code>pm2 start ecosystem.config.js --env development
// or
pm2 start ecosystem.config.js --env production
</code></pre></div><h5 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h5> <div class="language-js extra-class"><pre class="language-js"><code>pm2 start app<span class="token punctuation">.</span>js
pm2 list
pm2 <span class="token keyword">delete</span> <span class="token punctuation">[</span>app<span class="token operator">-</span>id<span class="token punctuation">]</span>
pm2 logs
pm2 logs <span class="token punctuation">[</span>app<span class="token operator">-</span>name<span class="token punctuation">]</span>
pm2 monit
<span class="token comment">// ...</span>
</code></pre></div><h3 id="命令行工具"><a href="#命令行工具" class="header-anchor">#</a> 命令行工具</h3> <p>本节介绍如何使用node写命令行工具。</p> <p>平时我们通常是使用<code>node index.js</code>去执行js代码。</p> <p>如果我们在文件的开头加上<code>#!/usr/bin/env node</code>则可以指定代码默认的运行环境，如下代码:</p> <div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
</code></pre></div><p>我们现在可以使用<code>./index.js</code>去执行该文件，默认的运行环境就是node。</p> <p>再进一步，我们在<code>package.json</code>中加上几行字段，如下:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;mycli&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>之后在当前目录下执行<code>npm link</code>，执行完之后我们就可以通过<code>mycli</code>命令来执行代码。</p> <p>在此基础上，介绍一些常用的库。</p> <h5 id="commander"><a href="#commander" class="header-anchor">#</a> commander</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> program <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span>
<span class="token comment">// 或者</span>
<span class="token comment">// const { Commander } = require('commander')</span>
<span class="token comment">// const program = new Commander()</span>
program
    <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">'1.0.0'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'命令行工具'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-t, --test'</span><span class="token punctuation">,</span> <span class="token string">'测试命令'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
program<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>program<span class="token punctuation">.</span>test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'测试成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// bash</span>
$mycli <span class="token operator">-</span>test 
测试成功
</code></pre></div><h5 id="readline"><a href="#readline" class="header-anchor">#</a> readline</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 官网代码</span>
<span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">,</span>
    output<span class="token operator">:</span> process<span class="token punctuation">.</span>stdout
<span class="token punctuation">}</span><span class="token punctuation">)</span>

rl<span class="token punctuation">.</span><span class="token function">question</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">answer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'666'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rl<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 官网代码</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">processLineByLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fileStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'log.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> fileStream<span class="token punctuation">,</span>
    crlfDelay<span class="token operator">:</span> <span class="token number">Infinity</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注意：我们使用 crlfDelay 选项将 input.txt 中的所有 CR LF 实例（'\r\n'）识别为单个换行符。</span>

  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> line <span class="token keyword">of</span> rl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// input.txt 中的每一行在这里将会被连续地用作 `line`。</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Line from file: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">processLineByLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/messiahhh/blog/edit/master/docs/frontend/node.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">8/31/2020, 2:02:35 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/frontend/javascript.html" class="prev">
        JavaScript
      </a></span> <span class="next"><a href="/blog/frontend/koa.html">
        Koa
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.92e3121e.js" defer></script><script src="/blog/assets/js/2.53a0586d.js" defer></script><script src="/blog/assets/js/26.00670705.js" defer></script>
  </body>
</html>
